import time
import sys

# Если пакет установлен через pip, просто:
from sdk.manipulators.medu import MEdu

HOST = "172.16.2.190"         # IP вашего манипулятора
CLIENT_ID = "test-client"     # любое
LOGIN = "user"                # любое (SDK не проверяет реальный логин/пароль)
PASSWORD = "pass"             # любое

# Позиции раскрытия клешни в условных градусах/шагаx привода (SDK ожидает целевые значения)
# Подберите мягко под свой инструмент; начнём с безопасных границ
GRIP_POSITIONS = [0, 20, 40, 60, 40, 20, 0]  # 0 = максимально «закрыт», 60 = умеренно «открыт»

# Скорость поворота захвата (безопасное умеренное значение)
GRIP_SPEED = 40  # условные единицы скорости привода захвата

def main():
    m = MEdu(HOST, CLIENT_ID, LOGIN, PASSWORD)
    try:
        print("[*] Подключение...")
        m.connect()
        print("[+] Подключено")

        print("[*] Запрашиваем доступ к управлению...")
        m.get_control()
        print("[+] Доступ получен")

        # Включаем питание инструментального узла на стреле (нужно для захвата/вакуумного насоса и т.п.)
        print("[*] Включаем питание инструмента на стреле...")
        m.nozzle_power(True)
        print("[+] Питание инструмента включено")

        # Небольшая задержка, чтобы всё стабилизировалось
        time.sleep(0.5)

        print("[*] Тестовое открытие/закрытие механического захвата...")
        for idx, pos in enumerate(GRIP_POSITIONS, start=1):
            print(f"  - Шаг {idx}: позиция захвата = {pos}, скорость = {GRIP_SPEED}")
            # Команда управления механическим захватом:
            # первый аргумент — целевая позиция захвата,
            # второй — скорость (по README SDK).
            m.manage_gripper(pos, GRIP_SPEED)
            time.sleep(0.7)

        print("[✓] Тест завершён успешно")

    except KeyboardInterrupt:
        print("\n[!] Прервано пользователем")
    except Exception as e:
        print("[!] Ошибка во время теста:", e)
        # полезно напечатать тип исключения
        print(type(e).__name__)
    finally:
        # Всегда внимательно выключаем питание инструмента и отпускаем управление
        try:
            print("[*] Выключаем питание инструмента...")
            m.nozzle_power(False)
            print("[+] Питание инструмента выключено")
        except Exception as e:
            print("[!] Не удалось выключить питание инструмента:", e)

        try:
            print("[*] Возврат управления...")
            m.release_control()
        except Exception:
            pass

        try:
            m.disconnect()
            print("[+] Отключено")
        except Exception:
            pass


if __name__ == "__main__":
    # На всякий случай попросим подтвердить, что зона чистая
    print("ВНИМАНИЕ: убедитесь, что рабочая зона манипулятора свободна от посторонних предметов и рук.")
    print("Продолжить? [y/N] ", end="", flush=True)
    ans = sys.stdin.readline().strip().lower()
    if ans == "y":
        main()
    else:
        print("Отмена.")
